import React, { useEffect, useRef } from "react";
import api from "../api/axiosInstance";
import * as pdfjsLib from "pdfjs-dist/build/pdf";
import pdfWorker from "pdfjs-dist/build/pdf.worker?url";

// tell pdf.js where its worker lives
pdfjsLib.GlobalWorkerOptions.workerSrc = pdfWorker;

// eslint-disable-next-line no-unused-vars
export default function DocumentViewer({ documentData, annotations, setAnnotations }) {

  const pdfContainer = useRef(null);

  // render the PDF pages
  const renderPDF = async (doc) => {
    try {
      const url = `http://localhost:4000/uploads/${doc.filename}`;
      const loadingTask = pdfjsLib.getDocument(url);
      const pdf = await loadingTask.promise;

      const container = pdfContainer.current;
      container.innerHTML = "";

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 1.2 });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        container.appendChild(canvas);
        await page.render({ canvasContext: context, viewport }).promise;
      }
    } catch (err) {
      console.error("PDF render error:", err);
    }
  };

  useEffect(() => {
    if (documentData.mimeType === "application/pdf") renderPDF(documentData);
  }, [documentData]);

  // handle text selection for .txt documents
  const handleSelection = async () => {
    const selection = window.getSelection();
    if (!selection || selection.isCollapsed) return;
    const text = selection.toString().trim();
    if (!text) return;

    const startOffset = selection.anchorOffset;
    const endOffset = selection.focusOffset;
    const comment = prompt("Add annotation comment:");
    if (!comment) return;

    try {
      const { data } = await api.post("/annotations", {
        documentId: documentData._id,
        userId: "dummy-user-id",
        startOffset,
        endOffset,
        comment,
      });
      setAnnotations((prev) => [...prev, data.annotation]);
    } catch (err) {
      alert(err.response?.data?.error || "Annotation failed");
    }
  };

  return (
    <div>
      {documentData.mimeType === "application/pdf" ? (
        <div ref={pdfContainer}></div>
      ) : (
        <div
          onMouseUp={handleSelection}
          style={{
            whiteSpace: "pre-wrap",
            lineHeight: "1.6",
            cursor: "text",
            background: "#fefefe",
            padding: "20px",
            borderRadius: "6px",
          }}
        >
          {documentData.textContent}
        </div>
      )}
    </div>
  );
}
